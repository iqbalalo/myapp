# This configuration file is placed in the same directory as docker-compose.yml
# and is mapped to the Nginx container's config.

events {
    worker_connections 1024;
}

http {
    # CRITICAL: Increase the maximum allowed size for the client request body (file upload)
    client_max_body_size 150M;

    # Increase proxy timeouts for long-running requests
    proxy_connect_timeout 900s;
    proxy_send_timeout 1200s;
    proxy_read_timeout 1200s;
    send_timeout 1200s;

    # Define an upstream block for PostgreSQL (using the service name 'db' and internal port 5432)
    upstream postgres_backend {
        server db:5432;
    }

    # Define an upstream block for Elasticsearch (using the service name 'es' and internal port 9200)
    upstream elasticsearch_backend {
        # Elasticsearch uses HTTP, so simple proxy_pass is fine.
        server es:9200;
    }

    # --- New Upstream Block for the API Service ---
    upstream api_backend {
        # 'api' is the service name from docker-compose.yml
        # '8000' is the internal port the FastAPI app listens on
        server api:8000;
    }

    server {
        # Nginx is listening on the container's port 80, which is mapped to host port 8080
        listen 80;
        server_name myapi.suslab-data.com; # Can be your EC2 IP or domain name

        # Reverse Proxy for PostgreSQL
        location /postgres/ {
            proxy_pass http://postgres_backend/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Reverse Proxy for Elasticsearch
        location /elasticsearch/ {
            proxy_pass http://elasticsearch_backend/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # --- New Location Block for the API Service ---
        location /api/ {
            # Use the upstream block to forward requests
            proxy_pass http://api_backend/;
            
            # Standard proxy headers to forward client info
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
        
        # Default route
        location / {
            return 200 "Services are running. Access Postgres via /postgres/, Elasticsearch via /elasticsearch/, and the API via /api/";
            add_header Content-Type text/plain;
        }
    }
}
